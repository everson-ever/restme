# Restme

## ⚠️ Do not use this gem yet. In progress

[![Gem Version](https://badge.fury.io/rb/restme.svg)](https://badge.fury.io/rb/restme)

Adds support for new controller actions such as pagination, filtering, sorting, and selecting specific model fields. Easily implement full CRUD functionality by importing Restme into your controller.

This gem manages your controller's responsibilities for:
- Read Actions: Providing complete pagination, filtering, sorting, and field selection for records.
- Create/Update Actions: Enabling automatic creation and updating of records.

## Installation



```bash
gem install restme
```

OR

```bash
gem 'restme', '~> 0.0.33'
```

## Usage

#### ℹ️ Current Version of gem require the following pré configs

 - Your models must include a current_user attribute (model.current_user). This attribute is used during create and update actions to set the user context at runtime, allowing it to be used in custom logic
 - Your user model must have a role attribute (user.role).
 - Your controllers must be named using the plural form of the model (e.g., Product → ProductsController). Alternatively, you can manually set the model name by defining the MODEL_NAME constant (e.g., MODEL_NAME = "Shopping").
 - You must create a folder inside app named restfy to define controller rules for authorization, scoping, creation, updating, and field selection (see example below).


### Usage examples


#### First of all

Include the Restme module in your controller (or, optionally, in your ApplicationController if you want it available globally):
```ruby
include Restme::Restme

before_action :initialize_restme  # This will authorize or deny the current action based on `ProductsController::Authorize::Rules` (see example below)
```

<br>
<br>

ProductsController example with restme
```ruby
module Api::V1::Products
  class ProductsController < ApplicationController
    include Restme::Restme

    before_action :initialize_restme

    def index
      render json: pagination_response, status: restme_scope_status
    end

    def show
      render json: model_scope_object, status: restme_scope_status
    end

    def create
      render json: creatable_record, status: restme_create_status
    end

    def update
      render json: updateable_record, status: restme_update_status
    end
  end
end
```
- `restme_scope_status`, `restme_create_status`, and `restme_update_status` are dynamic status codes generated by Restme.
- `model_scope_object` returns a single record or nil base on scope users.
- `pagination_response` returns the dynamic collection response generated by Restme.

<be><br>

Each Restme controller works together with its corresponding rules defined inside app/restfy. Restme dynamically loads the rules for each controller.

For example, ProductsController has the following rules:

### app/restfy/products_controller/authorize/rules.rb
- Used to verify if a user is authorized to access the current action based on their role.
```ruby
module ProductsController::Authorize
  class Rules
    ALLOWED_ROLES_ACTIONS = {
      create: %i[manager],
      index: %i[client manager],
      show: %i[client manager],
      update: %i[manager]
    }.freeze
  end
end
```

### app/restfy/products_controller/create/rules.rb
- Used to check if the current create action is within the user's scope. The example below checks if a manager is authorized to create a product for a specific establishment_id.
- `CREATABLE_ACTIONS_RULES` defines which controller actions are considered POST actions.
```ruby
module ProductsController::Create
  class Rules
    CREATABLE_ACTIONS_RULES = %i[create].freeze

    # The initialization of the create rules must receive the following three parameters: current_record (the record in memory), current_user, and the controller's params.
    def initialize(temp_record, current_user, controller_params = {})
      @temp_record = temp_record
      @current_user = current_user
      @controller_params = controller_params
    end

    def create_manager_scope?
      @current_user.manager.establishments.exists?(id: @temp_record.establishment_id)
    end
  end
end

```


### app/restfy/products_controller/scope/rules.rb
This rule defines which records are part of the current user's scope (i.e., visible to them).
```ruby
module ProductsController::Scope
  class Rules

    # The initialization of the scope rules must receive the following three parameters: current_record (the record in memory), current_user, and the controller's params.
    def initialize(klass, current_user, controller_params = {})
      @klass = klass
      @current_user = current_user
      @controller_params = controller_params
    end

    def client_scope
      @klass.all
    end

    def deliveryman_scope
      @klass.all
    end

    def manager_scope
      @klass.where(establishment_id: @current_user.manager.establishments.ids)
    end
  end
end


```


## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).

## Code of Conduct

Everyone interacting in the Restme project's codebases, issue trackers, chat rooms and mailing lists is expected to follow the [code of conduct](https://github.com/[USERNAME]/restme/blob/master/CODE_OF_CONDUCT.md).
